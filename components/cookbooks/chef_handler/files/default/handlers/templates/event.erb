<%
  def escape_string(s)
    to_escape = { '"'=>'\"', "\\"=>"\\\\" }
    s.to_s.gsub(/["\\]/) { |m| to_escape[m] }
  end
%>

[
  {
    "eventId": "<%= @event_id %>",
    "eventType": "chef-run",
    "data": {
      "status":  "<%= @status %>",
      "node": "<%= ((@run_status.node.respond_to? :fqdn) ? @run_status.node.fqdn : @run_status.node.name) %>",
      "start-time": "<%= @run_status.start_time %>",
      "end-time": "<%= @run_status.end_time %>",
      "elapsed-time": "<%= @run_status.elapsed_time %>",
      "resources": [
        <% @run_status.all_resources.each do |resource| -%>
        {
          "cookbook-name": "<%== escape_string(resource.cookbook_name) -%>",
          "cookbook-version": "<%== escape_string(resource.cookbook_version.manifest["version"]) -%>",
          "recipe_name": "<%== escape_string(resource.recipe_name) -%>",
          "action": "<%== escape_string(resource.action) -%>",
          "resource": "<%== escape_string(resource.name) -%>",
          "resource_type": "<%== escape_string(resource.resource_name) -%>",
          "updated": "<%== @run_status.updated_resources.any? {|res| res == resource} -%>"
        },
        <% end -%>
      ]
<% if @run_status.failed? -%>
        ,"exception": "<%== escape_string(@run_status.formatted_exception) %>"
        ,"stack-trace": "<%== escape_string(Array(@run_status.backtrace).join("\n")) %>"
<% end -%>    }
  }
]

